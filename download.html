<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tải ảnh Photobooth</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Comic+Sans+MS&display=swap" rel="stylesheet">
  <style>
    /* CSS tổng thể cho giao diện pastel, dễ thương */
    body {
      background: #e0f7fa; /* Nền màu xanh nhạt */
      font-family: 'Comic Sans MS', cursive, sans-serif; /* Font chữ vui tươi */
      margin: 0;
      padding: 0;
      color: #7ed6df; /* Màu chữ chính: xanh đậm */
    }

    /* Phần header của trang */
    .download-header {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #c0efff; /* Nền header màu xanh nhạt hơn */
      padding: 24px 0 12px 0;
      box-shadow: 0 2px 12px #a0e0ff; /* Đổ bóng nhẹ */
    }

    /* Tiêu đề ứng dụng */
    .photobooth-title {
      font-family: 'Pacifico', cursive; /* Font đặc biệt cho tiêu đề */
      font-size: 38px;
      color: #7ed6df;
      margin: 0 0 4px 0;
      letter-spacing: 2px;
    }

    /* Nút "Quay Lại" */
    .continue-btn {
      background: linear-gradient(135deg, #c0efff 0%, #a0e0ff 100%); /* Gradient màu xanh */
      color: #7ed6df;
      border: none;
      border-radius: 18px;
      padding: 18px 36px 10px 36px;
      font-size: 22px;
      font-family: 'Pacifico', cursive;
      font-weight: bold;
      margin: 32px auto 0 auto;
      display: block;
      box-shadow: 0 2px 16px #a0e0ff;
      text-align: center;
      transition: background 0.2s; /* Hiệu ứng chuyển động khi hover */
      cursor: pointer;
    }

    .continue-btn span {
      display: block;
      font-size: 15px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-weight: normal;
      margin-top: 2px;
      color: #7ed6df;
      opacity: 0.8;
    }

    .continue-btn:hover {
      background: #d0f0ff; /* Màu nền khi hover */
    }

    /* Trạng thái tải ảnh (ví dụ: "Bạn đã chụp X ảnh") */
    .download-status {
      text-align: center;
      color: #7ed6df;
      font-size: 18px;
      margin-top: 18px;
      margin-bottom: 0;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }

    /* Nút chung cho photobooth (Tải xuống) */
    .photobooth-btn {
      background: linear-gradient(135deg, #c0efff 0%, #a0e0ff 100%);
      color: #7ed6df;
      border: none;
      border-radius: 18px;
      padding: 14px 36px 10px 36px;
      font-size: 20px;
      font-family: 'Pacifico', cursive;
      font-weight: bold;
      margin: 18px auto 0 auto;
      display: block;
      box-shadow: 0 2px 16px #a0e0ff;
      text-align: center;
      transition: background 0.2s;
      cursor: pointer;
    }

    .photobooth-btn:hover {
      background: #d0f0ff;
    }

    /* Nút "Xóa tất cả ảnh" */
    .download-clear-btn {
      background: #7ed6df; /* Màu nền xanh đậm */
      color: #fff; /* Chữ trắng */
      border: none;
      border-radius: 12px;
      padding: 10px 24px;
      font-size: 16px;
      margin: 24px auto 0 auto;
      display: block;
      cursor: pointer;
      box-shadow: 0 2px 8px #a0e0ff;
    }

    .download-clear-btn:hover {
      background: #47b2c2; /* Màu nền khi hover */
    }

    /* Khu vực chính chứa các phần (Preview, Khung, Sticker) */
    .download-main {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 32px; /* Khoảng cách giữa các cột */
      margin: 32px auto 0 auto;
      max-width: 1200px; /* Chiều rộng tối đa cho desktop */
      min-height: 600px;
    }

    /* Các khối nội dung (Preview, Khung, Sticker) */
    .download-preview, .download-frames, .download-stickers {
      background: #fff; /* Nền trắng */
      border-radius: 24px;
      box-shadow: 0 2px 16px #a0e0ff;
      padding: 24px 18px 32px 18px;
      min-width: 320px;
      max-width: 350px;
      flex: 1 1 0; /* Cho phép các khối co giãn */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .download-preview {
      min-width: 340px; /* Kích thước tối thiểu cho phần preview */
    }

    /* Tiêu đề phụ trong các khối nội dung */
    .photobooth-sub {
      font-family: 'Pacifico', cursive;
      color: #7ed6df;
      font-size: 24px;
      margin-bottom: 12px;
    }

    /* Khu vực hiển thị ảnh preview */
    .preview-area {
      min-height: 320px; /* Chiều cao tối thiểu */
      background: #e0f7fa;
      border-radius: 18px;
      box-shadow: 0 2px 8px #a0e0ff;
      margin-bottom: 18px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative; /* Quan trọng cho việc định vị sticker */
      overflow: hidden; /* Đảm bảo sticker không tràn ra ngoài */
    }

    /* Danh sách các khung ảnh */
    .frame-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 cột trên desktop */
      gap: 16px;
      width: 100%;
      max-height: 400px; /* Giới hạn chiều cao và cho phép cuộn */
      overflow-y: auto;
      margin-bottom: 8px;
    }

    /* Ảnh thumbnail của khung */
    .frame-thumb {
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 2px 8px #a0e0ff;
      cursor: pointer;
      border: 3px solid transparent; /* Viền trong suốt mặc định */
      transition: border 0.2s; /* Hiệu ứng chuyển động khi chọn */
    }

    .frame-thumb.selected {
      border: 3px solid #7ed6df; /* Viền xanh khi được chọn */
    }

    /* Danh sách các sticker */
    .sticker-list {
      display: flex;
      flex-wrap: wrap; /* Cho phép sticker xuống dòng */
      gap: 12px;
      justify-content: center;
      width: 100%;
    }

    /* Ảnh thumbnail của sticker */
    .sticker-thumb {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      box-shadow: 0 2px 8px #a0e0ff;
      cursor: grab; /* Con trỏ kéo */
      background: #e0f7fa;
      border: 2px solid transparent;
      transition: border 0.2s;
    }

    .sticker-thumb:active {
      border: 2px solid #7ed6df; /* Viền xanh khi đang kéo */
    }

    /* Wrapper cho sticker đã thêm vào preview */
    .sticker-wrapper {
      position: absolute;
      /* Kích thước ban đầu được đặt bằng JS */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .draggable-sticker {
      width: 100%;
      height: 100%;
      pointer-events: none; /* Quan trọng để có thể kéo wrapper thay vì ảnh */
    }

    /* Nút điều khiển sticker (+, -, x) */
    .sticker-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: #e0f7fa;
      color: #7ed6df; /* Màu chữ */
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 8px #a0e0ff;
      cursor: pointer;
      z-index: 20; /* Đảm bảo nút nằm trên sticker */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .sticker-btn:hover {
      background: #c0efff;
      color: #47b2c2;
    }

    .sticker-delete {
      background: #47b2c2; /* Màu nền xanh đậm cho nút xóa */
      color: #fff;
      font-size: 15px;
    }

    .sticker-delete:hover {
      background: #8edfea;
      color: #47b2c2;
    }

    /* =================================================================== */
    /* Responsive Design cho Mobile (màn hình nhỏ hơn 1000px) */
    /* =================================================================== */
    @media (max-width: 1000px) {
      .download-main {
        flex-direction: column; /* Chuyển thành bố cục cột */
        align-items: center; /* Căn giữa các khối */
        gap: 18px; /* Khoảng cách giữa các khối */
        max-width: 98vw; /* Chiều rộng tối đa trên mobile */
        margin-top: 18px;
      }

      .download-preview, .download-frames, .download-stickers {
        min-width: unset; /* Bỏ giới hạn chiều rộng tối thiểu */
        max-width: 96vw; /* Chiều rộng tối đa trên mobile */
        width: 100%; /* Mở rộng hết chiều rộng khả dụng */
        padding: 18px 12px 24px 12px; /* Giảm padding */
      }

      .download-preview {
        max-width: 370px; /* Giới hạn chiều rộng cho preview */
      }

      .photobooth-title {
        font-size: 32px; /* Giảm kích thước tiêu đề */
      }

      .continue-btn, .photobooth-btn, .download-clear-btn {
        font-size: 20px;
        padding: 16px 0;
        width: 90vw; /* Chiều rộng nút lớn hơn */
        max-width: 340px;
        margin: 18px auto 0 auto;
        border-radius: 24px; /* Bo góc lớn hơn */
        box-shadow: 0 2px 12px #a0e0ff;
      }

      .preview-area {
        min-width: unset;
        max-height: 420px; /* Thay đổi từ height sang max-height */
        width: 100%;
        height: auto; /* Cho phép chiều cao tự động */
        overflow-y: auto; /* Cho phép cuộn dọc */
        max-width: 340px;
        margin: 0 auto 8px auto;
        border-radius: 16px;
        box-shadow: 0 2px 8px #a0e0ff;
      }

      .frame-list {
        grid-template-columns: repeat(3, 1fr); /* 3 cột cho khung trên mobile */
        gap: 12px;
        max-height: 300px; /* Giảm chiều cao tối đa */
      }

      .frame-thumb {
        width: 100%;
        height: auto; /* Chiều cao tự động theo tỉ lệ */
        border-radius: 10px;
      }

      .sticker-list {
        gap: 10px;
        justify-content: center;
      }

      .sticker-thumb {
        width: 56px;
        height: 56px;
        border-radius: 12px;
      }

      .photobooth-sub {
        font-size: 20px; /* Giảm kích thước tiêu đề phụ */
        margin-bottom: 10px;
      }

      .sticker-btn {
        width: 32px; /* Nút điều khiển sticker lớn hơn */
        height: 32px;
        font-size: 22px;
        border-radius: 50%;
        box-shadow: 0 2px 8px #a0e0ff;
      }

      .sticker-delete {
        font-size: 20px;
      }
    }

    /* =================================================================== */
    /* Responsive Design cho Mobile (màn hình nhỏ hơn 600px - điều chỉnh thêm) */
    /* =================================================================== */
    @media (max-width: 600px) {
      body {
        font-size: 16px;
        background: #e0f7fa; /* Nền hơi khác một chút */
      }
      .download-header {
        box-shadow: none; /* Bỏ bóng header */
        padding: 8px 0 0 0;
      }
      .photobooth-title {
        font-size: 28px;
        margin-bottom: 2px;
      }
      .download-main {
        margin-top: 8px;
        gap: 0;
      }
      .download-preview, .download-frames, .download-stickers {
        padding: 12px 4px 18px 4px;
        margin: 0 auto 12px auto;
      }
      .frame-list {
        grid-template-columns: repeat(2, 1fr); /* 2 cột cho khung trên màn hình rất nhỏ */
        gap: 8px;
        overflow-x: auto; /* Cuộn ngang */
        padding-bottom: 8px;
        flex-wrap: nowrap; /* Ngăn không cho xuống dòng */
      }
      .frame-thumb {
        width: 48px;
        height: 64px;
        border-radius: 8px;
      }
      .sticker-list {
        gap: 8px;
        overflow-x: auto; /* Cuộn ngang */
        flex-wrap: nowrap;
        justify-content: flex-start; /* Căn trái khi cuộn ngang */
      }
      .sticker-thumb {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        margin-bottom: 4px;
      }
      .photobooth-sub {
        font-size: 18px;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <header class="download-header">
    <h1 class="photobooth-title">FinnBooth</h1>
  </header>

  <!-- Hiển thị trạng thái hoặc yêu cầu chụp thêm ảnh -->
  <div id="downloadStatus" class="download-status"></div>
  <button id="continueBtn" class="continue-btn" style="display:none">
    Quay Lại
    <span>(Alo alo, về vị trí nào các vị ơi!)</span>
  </button>

  <main class="download-main photobooth-wrapper" id="mainDownloadArea">
    <!-- Phần xem trước ảnh -->
    <section class="download-preview photobooth-left">
      <h2 class="photobooth-sub">Preview</h2>
      <div id="previewArea" class="preview-area">
        <!-- Ảnh ghép sẽ hiển thị ở đây -->
      </div>
      <button id="downloadNewBtn" class="photobooth-btn">Tải xuống</button>
      <button id="clearBtn" class="download-clear-btn">Xóa tất cả ảnh</button>
    </section>

    <!-- Phần chọn khung ảnh -->
    <section class="download-frames photobooth-center">
      <h2 class="photobooth-sub">Chọn khung</h2>
      <div class="frame-list">
        <!-- Các ảnh khung mẫu. Bạn có thể thay đổi src và data-frame -->
        <img src="frame1.png" alt="Khung 1" class="frame-thumb selected" data-frame="frame1" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame2" alt="Khung 2" class="frame-thumb" data-frame="frame2" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame3" alt="Khung 3" class="frame-thumb" data-frame="frame3" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame4" alt="Khung 4" class="frame-thumb" data-frame="frame4" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame5" alt="Khung 5" class="frame-thumb" data-frame="frame5" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame6" alt="Khung 6" class="frame-thumb" data-frame="frame6" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame7" alt="Khung 7" class="frame-thumb" data-frame="frame7" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame8" alt="Khung 8" class="frame-thumb" data-frame="frame8" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame9" alt="Khung 9" class="frame-thumb" data-frame="frame9" />
        <img src="https://placehold.co/100x150/c0efff/7ed6df?text=Frame10" alt="Khung 10" class="frame-thumb" data-frame="frame10" />
      </div>
    </section>

    <!-- Phần chọn Sticker -->
    <section class="download-stickers photobooth-right">
      <h2 class="photobooth-sub">Sticker</h2>
      <div class="sticker-list">
        <!-- Các ảnh sticker mẫu. Bạn có thể thay đổi src -->
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S1" alt="Sticker 1" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S2" alt="Sticker 2" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S3" alt="Sticker 3" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S4" alt="Sticker 4" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S5" alt="Sticker 5" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S6" alt="Sticker 6" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S7" alt="Sticker 7" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S8" alt="Sticker 8" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S9" alt="Sticker 9" class="sticker-thumb" draggable="true" />
        <img src="https://placehold.co/64x64/c0efff/7ed6df?text=S10" alt="Sticker 10" class="sticker-thumb" draggable="true" />
      </div>
    </section>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const statusDiv = document.getElementById('downloadStatus');
      const continueBtn = document.getElementById('continueBtn');
      const mainArea = document.getElementById('mainDownloadArea');
      const previewArea = document.getElementById('previewArea');
      const downloadNewBtn = document.getElementById('downloadNewBtn');
      const clearBtn = document.getElementById('clearBtn');
      const frameThumbs = document.querySelectorAll('.frame-thumb');
      const stickerThumbs = document.querySelectorAll('.sticker-thumb');

      // Lấy ảnh đã chụp từ localStorage
      const data = localStorage.getItem('photobooth_images');
      let images = [];
      if (data) {
        images = JSON.parse(data);
      }

      const minImages = 2; // Số lượng ảnh tối thiểu cần có
      // Kiểm tra số lượng ảnh và hiển thị giao diện phù hợp
      if (!images || images.length < minImages) {
        mainArea.style.display = 'none'; // Ẩn phần chỉnh sửa
        statusDiv.innerHTML = `Bạn đã chụp <b>${images.length || 0}</b> ảnh. Hãy chụp đủ ${minImages} ảnh để tiếp tục!`;
        continueBtn.style.display = 'block'; // Hiển thị nút quay lại
        continueBtn.onclick = () => {
          window.location.href = 'index.html'; // Chuyển hướng về trang chụp ảnh
        };
        return; // Dừng thực thi script nếu không đủ ảnh
      } else {
        mainArea.style.display = ''; // Hiển thị phần chỉnh sửa
        statusDiv.innerHTML = `Bạn đã chụp <b>${images.length}</b> ảnh. Hãy chọn khung và tải về nhé!`;
        continueBtn.style.display = 'none'; // Ẩn nút quay lại
      }

      // Khung mặc định được chọn ban đầu
      let selectedFrame = frameThumbs[0] ? frameThumbs[0].getAttribute('src') : 'https://placehold.co/100x150/c0efff/7ed6df?text=Frame1';
      if (frameThumbs[0]) {
          frameThumbs[0].classList.add('selected'); // Chọn khung đầu tiên mặc định
      }

      let stickers = []; // Mảng lưu trữ các sticker đang có trên preview

      // Định nghĩa các vị trí slot ảnh trên khung (tọa độ và kích thước trên khung 681x2048)
      // Đây là các giá trị cố định dựa trên thiết kế khung ảnh của bạn
      const photoSlots = [
        { x: 44, y: 44, w: 593, h: 384 },
        { x: 44, y: 472, w: 593, h: 384 },
        { x: 44, y: 900, w: 593, h: 384 },
        { x: 44, y: 1328, w: 593, h: 384 }
      ];

      // Kích thước canvas preview và tỷ lệ scale từ khung gốc
      const previewWidth = 340;
      const previewHeight = 1024; // Tỷ lệ 1:3 tương ứng với khung 681x2048
      const scale = previewWidth / 681; // Tỷ lệ scale để hiển thị trên preview

      // Tính toán các vị trí slot ảnh trên canvas preview dựa trên tỷ lệ scale
      const previewSlots = photoSlots.map(slot => ({
        x: Math.round(slot.x * scale),
        y: Math.round(slot.y * scale),
        w: Math.round(slot.w * scale),
        h: Math.round(slot.h * scale)
      }));

      // Bán kính bo tròn cho các ảnh nhỏ
      const imageBorderRadius = 12; // Đơn vị pixel

      /**
       * Cắt và vẽ ảnh vào slot trên canvas, đảm bảo đúng tỉ lệ và căn giữa.
       * Áp dụng bo tròn góc cho ảnh.
       * @param {CanvasRenderingContext2D} ctx - Context của canvas.
       * @param {HTMLImageElement} img - Đối tượng ảnh gốc.
       * @param {Object} slot - Thông tin về vị trí và kích thước slot trên canvas.
       * @param {number} radius - Bán kính bo tròn góc.
       */
      function cropAndDrawImage(ctx, img, slot, radius) {
        const imgW = img.width;
        const imgH = img.height;
        const slotRatio = slot.w / slot.h; // Tỷ lệ khung hình của slot
        const imgRatio = imgW / imgH; // Tỷ lệ khung hình của ảnh gốc

        let sx = 0, sy = 0, sw = imgW, sh = imgH; // Source x, y, width, height (từ ảnh gốc)

        if (imgRatio > slotRatio) {
          // Ảnh rộng hơn slot, cần crop 2 bên
          sw = imgH * slotRatio;
          sx = Math.round((imgW - sw) / 2);
        } else {
          // Ảnh cao hơn slot, cần crop trên dưới
          sh = imgW / slotRatio;
          sy = Math.round((imgH - sh) / 2);
        }

        ctx.save(); // Lưu trạng thái canvas hiện tại

        // Tạo đường dẫn bo tròn góc
        ctx.beginPath();
        ctx.moveTo(slot.x + radius, slot.y);
        ctx.lineTo(slot.x + slot.w - radius, slot.y);
        ctx.arcTo(slot.x + slot.w, slot.y, slot.x + slot.w, slot.y + radius, radius);
        ctx.lineTo(slot.x + slot.w, slot.y + slot.h - radius);
        ctx.arcTo(slot.x + slot.w, slot.y + slot.h, slot.x + slot.w - radius, slot.y + slot.h, radius);
        ctx.lineTo(slot.x + radius, slot.y + slot.h);
        ctx.arcTo(slot.x, slot.y + slot.h, slot.x, slot.y + slot.h - radius, radius);
        ctx.lineTo(slot.x, slot.y + radius);
        ctx.arcTo(slot.x, slot.y, slot.x + radius, slot.y, radius);
        ctx.closePath();
        ctx.clip(); // Cắt ảnh theo đường dẫn này

        // Vẽ ảnh đã crop vào vị trí và kích thước của slot trên canvas
        ctx.drawImage(img, sx, sy, sw, sh, slot.x, slot.y, slot.w, slot.h);

        ctx.restore(); // Khôi phục trạng thái canvas (quan trọng để không ảnh hưởng đến các lần vẽ sau)
      }

      /**
       * Cập nhật ảnh preview trên giao diện.
       * Hàm này sẽ vẽ khung và các ảnh đã chụp lên một canvas.
       */
      function updatePreview() {
        previewArea.innerHTML = ''; // Xóa canvas cũ
        const canvas = document.createElement('canvas');
        canvas.width = previewWidth;
        canvas.height = previewHeight;
        const ctx = canvas.getContext('2d');

        const frameImg = new Image();
        frameImg.src = selectedFrame; // Sử dụng khung đã chọn
        frameImg.onload = () => {
          // Vẽ khung trước, sau đó vẽ ảnh lên trên
          ctx.drawImage(frameImg, 0, 0, previewWidth, previewHeight);

          let loadedImages = 0;
          const imgObjs = images.map(src => {
            const img = new Image();
            img.src = src;
            return img;
          });

          // Tải và vẽ từng ảnh đã chụp vào các slot
          imgObjs.forEach((img, i) => {
            img.onload = () => {
              loadedImages++;
              if (loadedImages === imgObjs.length) {
                // Khi tất cả ảnh đã tải xong, vẽ chúng lên canvas
                imgObjs.forEach((loadedImg, idx) => {
                  if (previewSlots[idx]) {
                    // Gọi hàm cropAndDrawImage với bán kính bo tròn
                    cropAndDrawImage(ctx, loadedImg, previewSlots[idx], imageBorderRadius * scale); // Scale bán kính cho preview
                  }
                });
                previewArea.appendChild(canvas); // Thêm canvas vào khu vực preview
              }
            };
            img.onerror = () => {
                console.error(`Không thể tải ảnh: ${img.src}`);
                // Có thể hiển thị placeholder hoặc thông báo lỗi trên preview
            };
          });
        };
        frameImg.onerror = () => {
          console.error(`Không thể tải file khung: ${selectedFrame}. Hãy kiểm tra lại file này!`);
          // Có thể hiển thị thông báo lỗi cho người dùng
        };
      }

      // Khởi tạo preview khi trang tải xong
      updatePreview();

      // Xử lý sự kiện chọn khung
      frameThumbs.forEach(frame => {
        frame.addEventListener('click', () => {
          selectedFrame = frame.getAttribute('src');
          frameThumbs.forEach(f => f.classList.remove('selected')); // Bỏ chọn tất cả
          frame.classList.add('selected'); // Chọn khung hiện tại
          updatePreview(); // Cập nhật preview
        });
      });

      // Hàm để thêm sticker vào preview (tái sử dụng logic từ drop event)
      function addStickerToPreview(src, initialX, initialY) {
          const wrapper = document.createElement('div');
          wrapper.className = 'sticker-wrapper';
          wrapper.style.position = 'absolute';
          wrapper.style.width = '64px'; // Kích thước sticker ban đầu
          wrapper.style.height = '64px';

          const img = document.createElement('img');
          img.src = src;
          img.className = 'draggable-sticker';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.pointerEvents = 'none'; // Quan trọng để có thể kéo wrapper

          // Tạo nút phóng to/thu nhỏ/xóa
          const btnPlus = document.createElement('button');
          btnPlus.textContent = '+';
          btnPlus.className = 'sticker-btn sticker-plus';
          btnPlus.style.position = 'absolute';
          btnPlus.style.right = '-12px'; // Vị trí nút
          btnPlus.style.top = '-12px';

          const btnMinus = document.createElement('button');
          btnMinus.textContent = '−';
          btnMinus.className = 'sticker-btn sticker-minus';
          btnMinus.style.position = 'absolute';
          btnMinus.style.left = '-12px'; // Vị trí nút
          btnMinus.style.top = '-12px';

          const btnDelete = document.createElement('button');
          btnDelete.textContent = '×';
          btnDelete.className = 'sticker-btn sticker-delete';
          btnDelete.style.position = 'absolute';
          btnDelete.style.right = '-12px'; // Vị trí nút
          btnDelete.style.bottom = '-12px';

          // Xử lý xóa sticker
          btnDelete.onclick = e => {
            e.stopPropagation(); // Ngăn sự kiện lan truyền ra ngoài (ví dụ: kéo)
            previewArea.removeChild(wrapper);
            stickers = stickers.filter(s => s !== wrapper); // Xóa khỏi mảng sticker
          };

          // Xử lý phóng to/thu nhỏ sticker
          btnPlus.onclick = e => {
            e.stopPropagation();
            let w = parseInt(wrapper.style.width);
            let h = parseInt(wrapper.style.height);
            w = Math.min(w + 16, 200); // Tăng kích thước, giới hạn 200px
            h = Math.min(h + 16, 200);
            wrapper.style.width = w + 'px';
            wrapper.style.height = h + 'px';
          };
          btnMinus.onclick = e => {
            e.stopPropagation();
            let w = parseInt(wrapper.style.width);
            let h = parseInt(wrapper.style.height);
            w = Math.max(w - 16, 32); // Giảm kích thước, giới hạn 32px
            h = Math.max(h - 16, 32);
            wrapper.style.width = w + 'px';
            wrapper.style.height = h + 'px';
          };

          // Thêm các phần tử vào wrapper
          wrapper.appendChild(img);
          wrapper.appendChild(btnPlus);
          wrapper.appendChild(btnMinus);
          wrapper.appendChild(btnDelete);

          // Đặt vị trí ban đầu của sticker
          wrapper.style.left = initialX + 'px';
          wrapper.style.top = initialY + 'px';

          // Kích hoạt chức năng kéo thả cho sticker mới
          makeStickerDraggable(wrapper, previewArea);
          makeStickerDraggableTouch(wrapper, previewArea);

          previewArea.appendChild(wrapper); // Thêm sticker vào preview
          stickers.push(wrapper); // Thêm vào mảng sticker
      }


      // Xử lý kéo thả sticker từ danh sách sticker
      stickerThumbs.forEach(sticker => {
        sticker.addEventListener('dragstart', e => {
          e.dataTransfer.setData('stickerSrc', sticker.getAttribute('src')); // Lưu src của sticker
        });

        // Thêm sự kiện click để thêm sticker
        sticker.addEventListener('click', e => {
            const src = sticker.getAttribute('src');
            // Đặt sticker ở giữa khu vực preview khi click
            const initialX = (previewArea.offsetWidth / 2) - 32; // 32 = 64px / 2 (nửa chiều rộng sticker ban đầu)
            const initialY = (previewArea.offsetHeight / 2) - 32; // 32 = 64px / 2 (nửa chiều cao sticker ban đầu)
            addStickerToPreview(src, initialX, initialY);
        });
      });

      // Xử lý thả sticker vào khu vực preview
      previewArea.addEventListener('dragover', e => e.preventDefault()); // Cho phép thả
      previewArea.addEventListener('drop', e => {
        e.preventDefault();
        const src = e.dataTransfer.getData('stickerSrc'); // Lấy src của sticker
        if (src) {
          const rect = previewArea.getBoundingClientRect();
          let x = e.clientX - rect.left - 32; // 32 = 64px / 2 (nửa chiều rộng sticker ban đầu)
          let y = e.clientY - rect.top - 32; // 32 = 64px / 2 (nửa chiều cao sticker ban đầu)

          // Đảm bảo sticker nằm trong giới hạn của previewArea
          x = Math.max(0, Math.min(x, previewArea.offsetWidth - 64)); // 64 là kích thước sticker ban đầu
          y = Math.max(0, Math.min(y, previewArea.offsetHeight - 64));

          addStickerToPreview(src, x, y);
        }
      });

      /**
       * Hàm xử lý kéo thả sticker bằng chuột (desktop).
       * @param {HTMLElement} sticker - Element sticker cần kéo.
       * @param {HTMLElement} container - Container chứa sticker (previewArea).
       */
      function makeStickerDraggable(sticker, container) {
        let offsetX, offsetY, isDragging = false;

        sticker.addEventListener('mousedown', e => {
          // Kiểm tra nếu click vào nút điều khiển thì không kéo
          if (e.target.classList.contains('sticker-btn')) return;
          isDragging = true;
          // Tính toán offset từ vị trí click đến góc trên bên trái của sticker
          const rect = sticker.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          sticker.style.zIndex = 10; // Đưa sticker lên trên cùng khi kéo
          e.preventDefault(); // Ngăn chọn văn bản
        });

        document.addEventListener('mousemove', e => {
          if (!isDragging) return;
          const containerRect = container.getBoundingClientRect();
          let x = e.clientX - containerRect.left - offsetX;
          let y = e.clientY - containerRect.top - offsetY;

          // Giới hạn vị trí sticker trong container
          x = Math.max(0, Math.min(x, container.offsetWidth - sticker.offsetWidth));
          y = Math.max(0, Math.min(y, container.offsetHeight - sticker.offsetHeight));

          sticker.style.left = x + 'px';
          sticker.style.top = y + 'px';
        });

        document.addEventListener('mouseup', () => {
          isDragging = false;
          sticker.style.zIndex = 1; // Đưa sticker về z-index bình thường
        });
      }

      /**
       * Hàm xử lý kéo thả sticker bằng cảm ứng (mobile).
       * @param {HTMLElement} sticker - Element sticker cần kéo.
       * @param {HTMLElement} container - Container chứa sticker (previewArea).
       */
      function makeStickerDraggableTouch(sticker, container) {
        let startX, startY, origX, origY, isDragging = false;

        sticker.addEventListener('touchstart', function(e) {
          if (e.target.classList.contains('sticker-btn')) return;
          isDragging = true;
          const touch = e.touches[0];
          startX = touch.clientX;
          startY = touch.clientY;
          // Lấy vị trí hiện tại của sticker
          origX = parseInt(sticker.style.left) || 0;
          origY = parseInt(sticker.style.top) || 0;
          sticker.style.zIndex = 10;
          e.preventDefault(); // Ngăn cuộn trang khi kéo
        }, { passive: false }); // `passive: false` để `preventDefault` hoạt động

        sticker.addEventListener('touchmove', function(e) {
          if (!isDragging) return;
          const touch = e.touches[0];
          let x = origX + (touch.clientX - startX);
          let y = origY + (touch.clientY - startY);

          const containerRect = container.getBoundingClientRect();
          // Giới hạn vị trí sticker trong container
          x = Math.max(0, Math.min(x, container.offsetWidth - sticker.offsetWidth));
          y = Math.max(0, Math.min(y, container.offsetHeight - sticker.offsetHeight));

          sticker.style.left = x + 'px';
          sticker.style.top = y + 'px';
          e.preventDefault();
        }, { passive: false });

        sticker.addEventListener('touchend', function() {
          isDragging = false;
          sticker.style.zIndex = 1;
        });
      }

      // Xử lý nút "Tải xuống"
      downloadNewBtn.addEventListener('click', function () {
        if (!images || images.length < 1) {
          alert('Bạn cần chụp ít nhất 1 ảnh để tải về!'); // Sử dụng alert tạm thời, nên thay bằng modal UI
          return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = 681; // Kích thước canvas cuối cùng cho ảnh tải về
        canvas.height = 2048;
        const ctx = canvas.getContext('2d');

        const frameImg = new Image();
        frameImg.src = selectedFrame;
        frameImg.onload = function () {
          ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height); // Vẽ khung lên canvas

          let loadedImages = 0;
          const imgObjs = images.map(src => {
            const img = new Image();
            img.src = src;
            return img;
          });

          imgObjs.forEach((img, i) => {
            img.onload = function () {
              loadedImages++;
              if (loadedImages === imgObjs.length) {
                // Khi tất cả ảnh đã tải xong, vẽ chúng vào các slot
                for (let idx = 0; idx < imgObjs.length; idx++) {
                  if (photoSlots[idx]) {
                    const slot = photoSlots[idx];
                    const originalImg = imgObjs[idx];

                    // --- CROP ẢNH VỀ ĐÚNG TỶ LỆ CỦA SLOT (ví dụ: 593x384) ---
                    const targetW = slot.w;
                    const targetH = slot.h;
                    const targetRatio = targetW / targetH;

                    let sx = 0, sy = 0, sw = originalImg.width, sh = originalImg.height;
                    const imgRatio = originalImg.width / originalImg.height;

                    if (imgRatio > targetRatio) {
                      // Ảnh rộng hơn slot, crop 2 bên
                      sw = originalImg.height * targetRatio;
                      sx = (originalImg.width - sw) / 2;
                    } else if (imgRatio < targetRatio) {
                      // Ảnh cao hơn slot, crop trên dưới
                      sh = originalImg.width / targetRatio;
                      sy = (originalImg.height - sh) / 2;
                    }

                    // Tạo canvas phụ để crop ảnh đúng tỷ lệ trước khi vẽ vào slot
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = targetW;
                    tempCanvas.height = targetH;
                    const tctx = tempCanvas.getContext('2d');
                    tctx.drawImage(originalImg, sx, sy, sw, sh, 0, 0, targetW, targetH);

                    // Vẽ ảnh đã crop từ tempCanvas vào vị trí slot trên canvas chính
                    // Áp dụng bo tròn góc cho ảnh khi tải về
                    ctx.save(); // Lưu trạng thái canvas
                    ctx.beginPath();
                    ctx.moveTo(slot.x + imageBorderRadius, slot.y);
                    ctx.lineTo(slot.x + slot.w - imageBorderRadius, slot.y);
                    ctx.arcTo(slot.x + slot.w, slot.y, slot.x + slot.w, slot.y + imageBorderRadius, imageBorderRadius);
                    ctx.lineTo(slot.x + slot.w, slot.y + slot.h - imageBorderRadius);
                    ctx.arcTo(slot.x + slot.w, slot.y + slot.h, slot.x + slot.w - imageBorderRadius, slot.y + slot.h, imageBorderRadius);
                    ctx.lineTo(slot.x + imageBorderRadius, slot.y + slot.h);
                    ctx.arcTo(slot.x, slot.y + slot.h, slot.x, slot.y + slot.h - imageBorderRadius, imageBorderRadius);
                    ctx.lineTo(slot.x, slot.y + imageBorderRadius);
                    ctx.arcTo(slot.x, slot.y, slot.x + imageBorderRadius, slot.y, imageBorderRadius);
                    ctx.closePath();
                    ctx.clip(); // Cắt ảnh theo đường dẫn bo tròn

                    ctx.drawImage(tempCanvas, slot.x, slot.y, slot.w, slot.h);
                    ctx.restore(); // Khôi phục trạng thái canvas
                  }
                }

                // Vẽ các sticker lên ảnh cuối cùng
                stickers.forEach(stickerWrapper => {
                  const stickerImg = stickerWrapper.querySelector('.draggable-sticker');
                  const x = parseInt(stickerWrapper.style.left) || 0;
                  const y = parseInt(stickerWrapper.style.top) || 0;
                  const width = parseInt(stickerWrapper.style.width) || 0;
                  const height = parseInt(stickerWrapper.style.height) || 0;

                  // Scale vị trí và kích thước sticker từ preview sang canvas tải về
                  const scaledX = x / scale;
                  const scaledY = y / scale;
                  const scaledWidth = width / scale;
                  const scaledHeight = height / scale;

                  ctx.drawImage(stickerImg, scaledX, scaledY, scaledWidth, scaledHeight);
                });

                // Tạo link tải ảnh và tự động click
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `photobooth_finnbooth.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              }
            };
            img.onerror = () => {
                console.error(`Không thể tải ảnh gốc: ${img.src}`);
            };
          });
        };
        frameImg.onerror = function () {
          alert('Không thể tải file khung. Hãy kiểm tra lại file này!'); // Sử dụng alert tạm thời
        };
      });

      // Xử lý nút "Xóa tất cả ảnh"
      clearBtn.onclick = () => {
        localStorage.removeItem('photobooth_images'); // Xóa dữ liệu ảnh
        location.reload(); // Tải lại trang
      };
    });
  </script>
</body>
</html>
